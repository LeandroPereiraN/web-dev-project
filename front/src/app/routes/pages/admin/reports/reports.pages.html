<section class="space-y-8">
  <header class="space-y-4">
    <div class="flex flex-col gap-2">
      <h1 class="text-3xl font-semibold text-slate-100">Reportes de contenido</h1>
      <p class="text-sm text-slate-400">
        Revisá los reportes enviados por la comunidad, filtrá por servicio o vendedor y tomá
        acciones sobre los servicios moderados.
      </p>
    </div>

    <form
      class="grid gap-4 rounded-3xl border border-slate-800/60 bg-slate-950/40 p-4 sm:grid-cols-2 lg:grid-cols-4"
      [formGroup]="filterForm"
      (ngSubmit)="applyFilters()"
    >
      <div class="flex flex-col gap-2">
        <label class="text-xs font-semibold uppercase tracking-wide text-slate-400">Estado</label>
        <p-select
          [options]="statusOptions"
          [formControl]="statusControl"
          optionLabel="label"
          optionValue="value"
          placeholder="Filtrar"
          styleClass="w-full"
        ></p-select>
      </div>

      <div class="flex flex-col gap-2">
        <label class="text-xs font-semibold uppercase tracking-wide text-slate-400"
          >ID de servicio</label
        >
        <input
          type="number"
          formControlName="serviceId"
          placeholder="Ej. 12"
          class="w-full rounded-xl border border-slate-800/60 bg-slate-900/70 px-3 py-2 text-sm text-slate-100 focus:border-cyan-400 focus:outline-none focus:ring-2 focus:ring-cyan-400/30"
        />
      </div>

      <div class="flex flex-col gap-2">
        <label class="text-xs font-semibold uppercase tracking-wide text-slate-400"
          >ID de vendedor</label
        >
        <input
          type="number"
          formControlName="sellerId"
          placeholder="Ej. 5"
          class="w-full rounded-xl border border-slate-800/60 bg-slate-900/70 px-3 py-2 text-sm text-slate-100 focus:border-emerald-400 focus:outline-none focus:ring-2 focus:ring-emerald-400/30"
        />
      </div>

      <div class="flex items-end gap-2">
        <button pButton type="submit" class="flex-1" label="Aplicar"></button>
        <button
          pButton
          type="button"
          class="p-button-text"
          label="Limpiar"
          (click)="clearFilters()"
        ></button>
      </div>
    </form>
  </header>

  @if (errorMessage()) {
  <p
    class="rounded-xl border border-dashed border-red-500/50 bg-red-500/10 px-4 py-3 text-sm text-red-200"
  >
    {{ errorMessage() }}
  </p>
  } @if (loading()) {
  <div class="space-y-3 rounded-3xl border border-slate-800/60 bg-slate-950/40 p-6">
    @for (skeleton of [0, 1, 2, 3, 4]; track $index) {
    <div class="flex items-center gap-6">
      <p-skeleton width="20%" height="1.1rem"></p-skeleton>
      <p-skeleton width="16%" height="1.1rem"></p-skeleton>
      <p-skeleton width="18%" height="1.1rem"></p-skeleton>
      <p-skeleton width="14%" height="1.1rem"></p-skeleton>
      <p-skeleton width="12%" height="1.1rem"></p-skeleton>
    </div>
    }
  </div>
  } @else if (reports().length) {
  <div class="rounded-3xl border border-slate-800/60 bg-slate-950/40">
    <p-table [value]="reports()" styleClass="!border-0" [tableStyle]="{ 'min-width': '100%' }">
      <ng-template pTemplate="header">
        <tr class="text-left text-sm uppercase tracking-wide text-slate-400">
          <th class="px-5 py-4">Servicio</th>
          <th class="px-5 py-4">Motivo</th>
          <th class="px-5 py-4">Reportado por</th>
          <th class="px-5 py-4">Fecha</th>
          <th class="px-5 py-4">Estado</th>
          <th class="px-5 py-4 text-right">Acciones</th>
        </tr>
      </ng-template>

      <ng-template pTemplate="body" let-report>
        <tr class="border-t border-slate-800/60 text-sm text-slate-300">
          <td class="px-5 py-4">
            <div class="flex flex-col">
              <span class="font-medium text-slate-100">{{ report.service.title }}</span>
              <span class="text-xs text-slate-500">ID #{{ report.serviceId }}</span>
            </div>
          </td>
          <td class="px-5 py-4">
            <p-tag
              [value]="resolveReasonLabel(report.reason)"
              severity="warn"
              styleClass="text-xs"
            ></p-tag>
          </td>
          <td class="px-5 py-4">
            <div class="flex flex-col">
              <span>{{ report.reporterEmail || 'Anónimo' }}</span>
              <span class="text-xs text-slate-500">Servicio #{{ report.service.id }}</span>
            </div>
          </td>
          <td class="px-5 py-4">
            {{ report.createdAt | date : 'dd/MM/yyyy HH:mm' }}
          </td>
          <td class="px-5 py-4">
            <p-tag
              [value]="resolveStatusLabel(report.isResolved)"
              [severity]="resolveStatusSeverity(report.isResolved)"
            ></p-tag>
          </td>
          <td class="px-5 py-4">
            <div class="flex flex-wrap items-center justify-end gap-2">
              <button
                pButton
                type="button"
                class="p-button-sm p-button-text"
                label="Detalles"
                (click)="openDetails(report)"
              ></button>
              <button
                pButton
                type="button"
                class="p-button-sm"
                [label]="resolveStatusLabel(!report.isResolved)"
                [severity]="report.isResolved ? 'warn' : 'success'"
                (click)="toggleReportStatus(report)"
              ></button>
              <button
                pButton
                type="button"
                class="p-button-sm p-button-success"
                label="Aprobar"
                icon="pi pi-check"
                (click)="openAction(report, 'approve')"
              ></button>
              <button
                pButton
                type="button"
                class="p-button-sm p-button-danger"
                label="Desactivar"
                icon="pi pi-ban"
                (click)="openAction(report, 'delete')"
              ></button>
            </div>
          </td>
        </tr>
      </ng-template>
    </p-table>

    <div class="border-t border-slate-800/60 px-4 py-3">
      <p-paginator
        [rows]="pageSize()"
        [first]="(page() - 1) * pageSize()"
        [totalRecords]="total()"
        [rowsPerPageOptions]="[5, 10, 20]"
        (onPageChange)="onPageChange($event)"
        styleClass="rounded-full border border-slate-800/60 bg-slate-900/50"
      ></p-paginator>
    </div>
  </div>
  } @else {
  <div
    class="flex flex-col items-center gap-4 rounded-3xl border border-dashed border-slate-800/60 bg-slate-950/40 px-8 py-16 text-center text-slate-400"
  >
    <i class="pi pi-inbox text-3xl text-slate-500"></i>
    <p class="max-w-md text-sm">
      No hay reportes para mostrar con el filtro seleccionado. ¡Buen trabajo manteniendo la
      comunidad en orden!
    </p>
  </div>
  }

  <p-dialog
    header="Detalle del reporte"
    [visible]="detailDialogVisible()"
    [modal]="true"
    [style]="{ width: '32rem' }"
    (visibleChange)="onDetailDialogVisibilityChange($event)"
  >
    @if (detailReport(); as detail) {
    <div class="space-y-4 text-sm text-slate-300">
      <div class="space-y-2">
        <p class="text-xs uppercase tracking-wide text-slate-500">Servicio</p>
        <p class="mt-1 font-medium text-slate-100">{{ detail.service.title }}</p>
        <p class="text-xs text-slate-500">ID #{{ detail.service.id }}</p>
        <div class="mt-2 rounded-2xl border border-slate-800/60 bg-slate-950/60 p-3">
          @if (serviceDetailLoading()) {
          <div class="space-y-2">
            <p-skeleton width="60%" height="1rem"></p-skeleton>
            <p-skeleton width="90%" height="0.85rem"></p-skeleton>
            <p-skeleton width="80%" height="0.85rem"></p-skeleton>
          </div>
          } @else if (serviceDetail(); as service) {
          <div class="space-y-2 text-sm">
            <p class="text-slate-300">{{ service.description }}</p>
            <div class="grid gap-2 text-xs text-slate-400 sm:grid-cols-2">
              <span
                >Precio base:
                <strong class="text-slate-200">{{
                  service.basePrice | currency : 'UYU'
                }}</strong></span
              >
              <span
                >Tipo: <strong class="text-slate-200">{{ service.priceType }}</strong></span
              >
              <span
                >Estado:
                <strong class="text-slate-200">{{
                  service.isActive ? 'Activo' : 'Inactivo'
                }}</strong></span
              >
              <span
                >Categoría:
                <strong class="text-slate-200">{{ service.category.name }}</strong></span
              >
            </div>
            @if (service.images.length) {
            <div class="mt-2 grid grid-cols-3 gap-2">
              @for (image of service.images; track image.id) {
              <img
                [src]="image.imageUrl"
                alt="Imagen del servicio"
                class="h-20 w-full rounded-lg object-cover"
              />
              }
            </div>
            }
          </div>
          } @else {
          <p class="text-sm text-slate-500">No pudimos cargar los detalles del servicio.</p>
          }
        </div>
      </div>
      <div>
        <p class="text-xs uppercase tracking-wide text-slate-500">Motivo</p>
        <p-tag class="mt-2" severity="warn" [value]="resolveReasonLabel(detail.reason)"></p-tag>
      </div>
      <div>
        <p class="text-xs uppercase tracking-wide text-slate-500">Descripción del reporte</p>
        <p class="mt-1 whitespace-pre-line text-slate-300">
          {{ detail.details || 'El reporte no incluye detalles adicionales.' }}
        </p>
        @if (detail.otherReasonText) {
        <p class="mt-2 rounded-lg bg-slate-900/60 px-3 py-2 text-xs text-slate-400">
          {{ detail.otherReasonText }}
        </p>
        }
      </div>
      <div class="grid grid-cols-2 gap-3 text-xs text-slate-400">
        <div>
          <p class="uppercase tracking-wide">Reportado</p>
          <p class="mt-1 text-slate-200">{{ detail.createdAt | date : 'dd/MM/yyyy HH:mm' }}</p>
        </div>
        <div>
          <p class="uppercase tracking-wide">Estado actual</p>
          <p class="mt-1 text-slate-200">{{ resolveStatusLabel(detail.isResolved) }}</p>
        </div>
      </div>

      <div class="rounded-2xl border border-slate-800/60 bg-slate-950/60 p-4">
        <div class="flex flex-wrap items-start justify-between gap-4">
          <div>
            <p class="text-xs uppercase tracking-wide text-slate-500">Vendedor</p>
            @if (sellerProfileLoading()) {
            <div class="mt-2 space-y-1">
              <p-skeleton width="160px" height="1.1rem"></p-skeleton>
              <p-skeleton width="120px" height="0.85rem"></p-skeleton>
            </div>
            } @else if (sellerProfile(); as seller) {
            <div class="mt-2 space-y-1">
              <p class="text-base font-medium text-slate-100">
                {{ seller.firstName }} {{ seller.lastName }}
              </p>
              <p class="text-sm text-slate-400">{{ seller.email }}</p>
              @if (seller.phone) {
              <p class="text-xs text-slate-500">{{ seller.phone }}</p>
              }
              <div class="grid grid-cols-2 gap-2 text-xs text-slate-400">
                <span
                  >Trabajos:
                  <strong class="text-slate-100">{{ seller.totalCompletedJobs }}</strong></span
                >
                <span
                  >Rating:
                  <strong class="text-slate-100">{{
                    seller.averageRating | number : '1.1-1'
                  }}</strong></span
                >
              </div>
            </div>
            } @else {
            <p class="text-sm text-slate-500">No pudimos cargar el perfil del vendedor.</p>
            }
          </div>
          <div class="flex flex-col items-end gap-2">
            <p-tag
              [value]="resolveSellerStatusLabel()"
              [severity]="isSellerSuspended() ? 'danger' : 'success'"
            ></p-tag>
            <div class="flex flex-wrap justify-end gap-2">
              <button
                pButton
                type="button"
                class="p-button-sm"
                [severity]="isSellerSuspended() ? 'success' : 'warn'"
                [label]="isSellerSuspended() ? 'Reactivar' : 'Suspender'"
                icon="pi pi-user-lock"
                (click)="
                  openSellerAction(
                    isSellerSuspended() ? 'activate' : 'suspend',
                    detail.service.sellerId
                  )
                "
              ></button>
              <button
                pButton
                type="button"
                class="p-button-sm p-button-danger"
                label="Eliminar"
                icon="pi pi-user-minus"
                (click)="openSellerAction('delete', detail.service.sellerId)"
              ></button>
            </div>
          </div>
        </div>
      </div>
    </div>
    }
  </p-dialog>

  <p-dialog
    [header]="resolveActionLabel(actionType())"
    [visible]="actionDialogVisible()"
    [modal]="true"
    [style]="{ width: '34rem' }"
    (visibleChange)="onActionDialogVisibilityChange($event)"
  >
    @if (actionReport(); as target) {
    <form class="space-y-5" [formGroup]="actionForm" (ngSubmit)="submitAction()">
      <div class="rounded-2xl bg-slate-900/60 px-4 py-3 text-sm text-slate-300">
        <p class="text-xs uppercase tracking-wide text-slate-500">Servicio</p>
        <p class="mt-1 font-medium text-slate-100">{{ target.service.title }}</p>
        <p class="text-xs text-slate-500">ID #{{ target.service.id }}</p>
      </div>

      <div class="flex flex-col gap-2">
        <label class="text-xs font-semibold uppercase tracking-wide text-slate-400"
          >Justificación</label
        >
        <textarea
          formControlName="justification"
          rows="4"
          placeholder="Explicá la decisión que vas a tomar"
          class="w-full rounded-xl border border-slate-800/60 bg-slate-900/70 px-3 py-3 text-sm text-slate-100 shadow-inner shadow-slate-950/30 focus:border-cyan-400 focus:outline-none focus:ring-2 focus:ring-cyan-400/30"
        ></textarea>
        @if ( actionForm.controls.justification.invalid && actionForm.controls.justification.touched
        ) {
        <span class="text-xs text-red-300"
          >Ingresá una justificación de al menos 10 caracteres.</span
        >
        }
      </div>

      <div class="flex flex-col gap-2">
        <label class="text-xs font-semibold uppercase tracking-wide text-slate-400"
          >Notas internas (opcional)</label
        >
        <textarea
          formControlName="internalNotes"
          rows="3"
          placeholder="Este texto se guarda solo para el equipo de moderación"
          class="w-full rounded-xl border border-slate-800/60 bg-slate-900/70 px-3 py-3 text-sm text-slate-100 shadow-inner shadow-slate-950/30 focus:border-cyan-400 focus:outline-none focus:ring-2 focus:ring-cyan-400/30"
        ></textarea>
      </div>

      <div class="flex justify-end gap-3">
        <button
          pButton
          type="button"
          class="p-button-text"
          label="Cancelar"
          (click)="closeActionDialog()"
        ></button>
        <button
          pButton
          type="submit"
          [loading]="actionSubmitting()"
          [disabled]="actionSubmitting()"
          [label]="resolveActionLabel(actionType())"
          [severity]="actionType() === 'approve' ? 'success' : 'danger'"
        ></button>
      </div>
    </form>
    }
  </p-dialog>

  <p-dialog
    [header]="resolveSellerActionLabel(sellerActionType())"
    [visible]="sellerActionDialogVisible()"
    [modal]="true"
    [style]="{ width: '32rem' }"
    (visibleChange)="onSellerActionDialogVisibilityChange($event)"
  >
    <form class="space-y-5" [formGroup]="sellerActionForm" (ngSubmit)="submitSellerAction()">
      <p class="text-sm text-slate-400">
        Cada acción requiere una justificación clara para dejar registro interno y notificar al
        vendedor.
      </p>
      <div class="flex flex-col gap-2">
        <label class="text-xs font-semibold uppercase tracking-wide text-slate-400"
          >Justificación</label
        >
        <textarea
          formControlName="justification"
          rows="4"
          placeholder="Explicá el motivo de la sanción"
          class="w-full rounded-xl border border-slate-800/60 bg-slate-900/70 px-3 py-3 text-sm text-slate-100 focus:border-rose-400 focus:outline-none focus:ring-2 focus:ring-rose-400/30"
        ></textarea>
        @if ( sellerActionForm.controls.justification.invalid &&
        sellerActionForm.controls.justification.touched ) {
        <span class="text-xs text-red-300">Ingresá al menos 10 caracteres.</span>
        }
      </div>

      <div class="flex flex-col gap-2">
        <label class="text-xs font-semibold uppercase tracking-wide text-slate-400"
          >Notas internas (opcional)</label
        >
        <textarea
          formControlName="internalNotes"
          rows="3"
          placeholder="Solo visible para el equipo de moderación"
          class="w-full rounded-xl border border-slate-800/60 bg-slate-900/70 px-3 py-3 text-sm text-slate-100 focus:border-amber-400 focus:outline-none focus:ring-2 focus:ring-amber-400/30"
        ></textarea>
      </div>

      <div class="flex justify-end gap-3">
        <button
          pButton
          type="button"
          class="p-button-text"
          label="Cancelar"
          (click)="closeSellerActionDialog()"
        ></button>
        <button
          pButton
          type="submit"
          [loading]="sellerActionSubmitting()"
          [disabled]="sellerActionSubmitting()"
          [severity]="
            sellerActionType() === 'activate'
              ? 'success'
              : sellerActionType() === 'suspend'
              ? 'warn'
              : 'danger'
          "
          [label]="resolveSellerActionLabel(sellerActionType())"
        ></button>
      </div>
    </form>
  </p-dialog>
</section>
